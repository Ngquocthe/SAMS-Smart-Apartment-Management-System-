name: CI/CD API (Docker â€“ No compose)

on:
  push:
    branches: [develop]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore SAMS-BE/SAMS-BE.sln

      - name: Build
        run: dotnet build SAMS-BE/SAMS-BE.sln -c Release --no-restore

      - name: Publish
        run: dotnet publish SAMS-BE/SAMS-BE.sln -c Release -o publish

      # ðŸ§¹ Cleanup tmp trÃªn server
      - name: Cleanup tmp folder on server
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            rm -rf /var/www/api-app/tmp/*
            mkdir -p /var/www/api-app/tmp

      # ðŸ“¦ Copy source + publish
      - name: Copy source code to server
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          source: "."
          target: "/var/www/api-app/tmp"
          strip_components: 1

      # ðŸš€ Build & run API container
      - name: Build and restart API container
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            cd /var/www/api-app

            echo "Replacing current source..."
            rm -rf current/*
            cp -r tmp/* current/

            echo "Stopping old api (if any)..."
            docker rm -f api || true

            echo "Building API image..."
            cd current
            docker build -t api .

            echo "Starting API..."
            docker run -d \
              --name api \
              -p 127.0.0.1:5000:80 \
              --restart unless-stopped \
              api

            echo "Health check..."
            sleep 5
            curl -f http://127.0.0.1:5000/api/health
